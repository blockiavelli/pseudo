$domainName = "test.local"
$password = "TestPassword"
$user = "Administrator"
$credential = New-Object System.Management.Automation.PSCredential($user, (ConvertTo-SecureString $password -AsPlainText -Force))
$timeout = New-TimeSpan -Minutes 5
$stopwatch = [System.Diagnostics.Stopwatch]::StartNew()

while ($stopwatch.Elapsed -lt $timeout) {
    try {
        Add-Computer -DomainName $domainName -Credential $credential -ErrorAction Stop
        Write-Host "Successfully joined the domain '$domainName'. A restart is required to apply changes."
        break
    }
    catch {
        Write-Warning "Failed to join domain. Error: $($_.Exception.Message). Retrying in 10 seconds..."
        Start-Sleep -Seconds 10
    }
}

if ($stopwatch.Elapsed -ge $timeout) {
    throw "Failed to join domain '$domainName' within 5 minutes."
}
