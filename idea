def get_unused_ips_from_subnet(subnet_name):
    """
    Get all unused IP addresses from a subnet with the given name.
    
    Args:
        subnet_name (str): Name of the subnet to query
        
    Returns:
        list: List of unused IP addresses as strings
    """
    try:
        # Initialize EC2 client
        ec2_client = boto3.client('ec2', region_name='us-west-2')
        
        # Find the subnet by name
        response = ec2_client.describe_subnets(
            Filters=[
                {'Name': 'tag:Name', 'Values': [subnet_name]}
            ]
        )
        
        if not response['Subnets']:
            raise ValueError(f"Subnet '{subnet_name}' not found")
        
        subnet = response['Subnets'][0]
        subnet_id = subnet['SubnetId']
        cidr_block = subnet['CidrBlock']
        
        # Get all network interfaces in the subnet to find used IPs
        used_ips = set()
        
        # Get all network interfaces in the subnet
        paginator = ec2_client.get_paginator('describe_network_interfaces')
        for page in paginator.paginate(
            Filters=[
                {'Name': 'subnet-id', 'Values': [subnet_id]}
            ]
        ):
            for network_interface in page['NetworkInterfaces']:
                # Add primary private IP
                if 'PrivateIpAddress' in network_interface:
                    used_ips.add(network_interface['PrivateIpAddress'])
                
                # Add secondary private IPs
                if 'PrivateIpAddresses' in network_interface:
                    for private_ip_info in network_interface['PrivateIpAddresses']:
                        if 'PrivateIpAddress' in private_ip_info:
                            used_ips.add(private_ip_info['PrivateIpAddress'])
        
        # Generate all IPs in the CIDR block
        network = ipaddress.ip_network(cidr_block, strict=False)
        all_ips = [str(ip) for ip in network.hosts()]  # Exclude network and broadcast addresses
        
        # Find unused IPs (IPs not in the used_ips set)
        unused_ips = [ip for ip in all_ips if ip not in used_ips]
        
        # Sort the IPs for better readability
        unused_ips.sort(key=lambda x: ipaddress.IPv4Address(x))
        
        return unused_ips
        
    except ClientError as e:
        raise Exception(f"AWS API error: {str(e)}")
    except Exception as e:
        raise Exception(f"Error getting unused IPs: {str(e)}")

@app.route('/api/available-ips', methods=['GET'])
def get_available_ips():
    """Get available (unused) IP addresses from SampleSubnet"""
    try:
        unused_ips = get_unused_ips_from_subnet('SampleSubnet')
        return jsonify({'ips': unused_ips, 'count': len(unused_ips)}), 200
    except Exception as e:
        return jsonify({'error': str(e)}), 500
